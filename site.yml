---
- hosts: all
  become: yes

  vars_files:
    - vars/main.yml

  roles:
    - role: pre_check
    - role: middleware_control
      tasks_from: stop.yml
    - role: system_update
    - role: middleware_control
      tasks_from: start.yml
    - role: post_check

  tasks:
    - name: "创建本地报告目录"
      debug:
        msg: "在控制节点上创建目录 {{ local_report_dir }} 用于存放从远程节点复制过来的报告文件。"

    - name: "创建本地报告目录"
      ansible.builtin.file:
        path: "{{ local_report_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    - name: "从各个节点复制报告到控制节点"
      ansible.builtin.fetch:
        src: "{{ report_path }}"
        dest: "{{ local_report_dir }}{{ inventory_hostname }}_{{ ansible_date_time.date }}_patch_report.csv"
        flat: yes

    - name: "报告文件复制路径"
      debug:
        msg: "报告文件已从节点 {{ inventory_hostname }} 复制到控制节点的 {{ local_report_dir }}{{ inventory_hostname }}_{{ ansible_date_time.date }}_patch_report.csv"
